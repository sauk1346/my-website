# Repaso NoSql

- **Estructura flexible:** el doc1 puede tener una estructura diferente del doc2 aún si pertenecen a la misma colección

- desventajas
    - datos no fiables
    - normalización de datos

## Operadores relacionales de comparación

Ejemplo:

- Buscar todos los productos cuyo precio es mayor a 3000
```js
db.productos.find( {"precio":{ $gte: 3000 } } )
```

## Operadores lógicos

|Operador|Descripción|Ejemplo|
|---|---|---|
|`$and`|Todas la condiciones deben cumplirse|`{ $and:[ { edad:{$gt:18} },{ ciudad:"Osorno } ] }`|
|`$or`|Al menos una condición debe cumplirse|`{ $or:[ {stock:0},{categoria:"Obsoletos} ] }`|
|`$not`|Niega una condicion|`{ stock:{ $not:{$gt:0} } }`|
|`$nor`|Ninguna condición debe cumplirse|`{ $nor:[ {ciudad:"Temuco"}, {ciudad:"Valdivia"} ] }`|


**Ejemplo**

```js
db.clientes.find({
    $or:[
        {edad:{$lt:18}},
        {ciudad:"Puerto Montt"}
    ]
})
```

## Arrays

Ejemplo

```json
{
    "nombre": "Carlos",
    "etiquetas": ["activo", "vip", "newsletter"]
}
```

para consultar se utiliza:

```js
db.usuarios.find({ etiquetas:"vip" })
```

El cual busca todos los documentos donde el array etiquetas contenga "vip"

## Subdocumentos
Es un objeto dentro de otro documento

```json
{
    "nombre": "Sofía",
    "direccion":{
        "ciudad":"Osorno",
        "region":"Los Lagos"
    }
}
```

Luego para buscar:

```js
db.usuarios.find({"direccion.ciudad":"Osorno"})
```

## Consultas sobre Arrays

|Operador|Qué hace|Ejemplo|
|---|---|---|
|`$in`|||
|`$all`|||
|`$size`|||
|`$elemMAtch`|||

## Manejo de fechas

1. Insertar una fecha:
```js
{fechaRegistro: ISODate("2024-03-30")}
```

2. Comparar fechas:


3. Filtrar por rango:


## Filtro y búsquedas anidadas

```js
db.alumnos.find({ "contacto.email":{$ne:null} })
```

También se puede usar condiciones combinadas en subdocumentos

```js
db.alumnos.find({
    "direccion.region":"Los Lagos",
    "direccion.comuna":"Puerto Montt"
})
```


## Estructuras jerárquicas (array de subdocumentos)

```json
{
    "nombre": "Pablo",
    "compras": [
        {
            "producto": "Monitor",
            "precio": "120000"
        },
        {
            "producto": "Teclado",
            "precio": 30000
        }
    ]
}
```

Luego consulta con $elemMAtch (busca aunq tenga un solo registro)

```js
db.usuarios.find({
    compras: {$elmMatch: {producto}}
})
```



# Ejercicios

## Ejercicio 01
Mostrar todos los usuarios que tengan más de 30 años

<details>
    <summary style={{color:'red'}}>Solución</summary>
```js
db["usuarios"].find({"edad":{$gt:30}})
```
</details>

## Ejercicio 02

Encontrar todos los usuarios que son de Valdivia

<details>
    <summary style={{color:'red'}}>Solución</summary>
```js
db.usuarios.find({"direccion.ciudad":"Valdivia"})
```
</details>

## Ejercicio 03
Mostrar usuarios con la etiqueta "vip" en su campo etiquetas

<details>
    <summary style={{color:'red'}}>Solución</summary>
```js
db.usuarios.find({ etiquetas:"vip" })
```
</details>

## Ejercicio 04
Mostrar los usuarios que se registraron después del 1 de febrero del 2024

<details>
    <summary style={{color:'red'}}>Solución</summary>
```js
db.usuarios.find({fechaRegistro:{$gt:ISODate("2024-02-01")}})
```
</details>

## Ejercicio 05
Mostrar usuarios con edad entre 25 y 35 años

<details>
    <summary style={{color:'red'}}>Solución</summary>
```js
db.usuarios.find({edad:{$gte:25,$lte:35}})
```

opcional
```js
db.usuarios.find({$and: [ {edad: {$gte:25}},{edad:{$lte:35}} ]})
```
</details>

## Ejercicio 06
Mostrar usuarios que no tengan compras registradas

<details>
    <summary style={{color:'red'}}>Solución</summary>
```js
db.usuarios.find({"compras":{$size:0}})
```
</details>

## Ejercicio 07
Buscar usuarios que hayan comprado un producto llamado "Notebook"

<details>
    <summary style={{color:'red'}}>Solución</summary>
```js
db.usuarios.find({
    compras:{$elemMatch:{producto:"Notebook"}}
})
```
</details>

## Ejercicio 08
Mostrar los ususarios que viven en la región "Los Lagos" y tienen etiqueta "newsletter"

<details>
    <summary style={{color:'red'}}>Solución</summary>
```js
db.usuarios.find("direccion.region":"Los Lagos", etiqueta: "newsletter")
```
</details>

## Ejercicio 09
Mostrar los usuario ue tienen más de una etiqueda

<details>
    <summary style={{color:'red'}}>Solución</summary>
```js
db.usuarios.find({
    etiquetas: {$exists: true},
    $expr: {$gt: [ { $size: "$etiquetas"}, 1 ]}
})
```
</details>

