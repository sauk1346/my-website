import ExternalLink from '@/components/ExternalLink';

# Prueba - MongoDB Consultas Avanzadas (Versión C)

## Ayuda de términos útiles para consultas en MongoDB
- $gt, $lt, $gte, $lte, $eq, $ne: Comparaciones
- $and, $or, $not, $nor: Lógicos
- $regex: Expresiones regulares
- $size, $elemMatch: Arrays
- $expr: Comparación entre campos
- $avg, $add, $divide, $strLenCP: Funciones dentro de $expr

## Instrucciones
- **Base de datos:** empresaDB
- **Colección:** empleados
- **JSON:** <ExternalLink href>empleados.json</ExternalLink>

Responde los siguientes ejercicios usando consultas en MongoDB Shell

## Ejercicio 01
Buscar empleados cuyo nombre contenga la letra 'e' al menos dos veces.

<details>
    <summary>Solución</summary>
```js
db.empleados.find({
    nombre: /.*e.*e.*/i
})
```
</details>

## Ejercicio 02
Filtrar empleados cuyo sueldo esté entre $1.200.000 y $2.000.000.

<details>
    <summary>Solución</summary>
```js
db.empleados.find({
  sueldo: { $gte: 1200000, $lte: 2000000 }
})
```
</details>

## Ejercicio 03
Mostrar empleados activos que vivan fuera de 'Providencia'.

<details>
    <summary>Solución</summary>
```js
db.empleados.find({
    activo: true,
    comuna: {$ne: "Providencia"}
})
```
</details>

## Ejercicio 04
Listar empleados contratados en 2020.

<details>
    <summary>Solución</summary>
```js
db.empleados.find({
    contratado: { $gte: "2020-01-01", $lte: "2020-12-31" }
})
```
</details>

## Ejercicio 05
Buscar empleados del área de 'Diseño' o 'Marketing'.

<details>
    <summary>Solución</summary>
```js
db.empleados.find({
    area: {$in: ["Diseño", "Marketing"]}
})
```
</details>

## Ejercicio 06
Mostrar empleados cuya evaluación promedio sea menor a 4.5.

<details>
    <summary>Solución</summary>
```js
db.empleados.find({
  $or: [
    // Caso: 2 evaluaciones (2021-2022) con promedio < 4.5
    {
      "evaluaciones.2021": { $exists: true },
      "evaluaciones.2022": { $exists: true },
      "evaluaciones.2023": { $exists: false },
      $expr: {
        $lt: [
          { $divide: [
              { $add: ["$evaluaciones.2021", "$evaluaciones.2022"] },
              2
          ]},
          4.5
        ]
      }
    },
    // Caso: 2 evaluaciones (2022-2023) con promedio < 4.5
    {
      "evaluaciones.2021": { $exists: false },
      "evaluaciones.2022": { $exists: true },
      "evaluaciones.2023": { $exists: true },
      $expr: {
        $lt: [
          { $divide: [
              { $add: ["$evaluaciones.2022", "$evaluaciones.2023"] },
              2
          ]},
          4.5
        ]
      }
    },
    // Caso: 2 evaluaciones (2021-2023) con promedio < 4.5
    {
      "evaluaciones.2021": { $exists: true },
      "evaluaciones.2022": { $exists: false },
      "evaluaciones.2023": { $exists: true },
      $expr: {
        $lt: [
          { $divide: [
              { $add: ["$evaluaciones.2021", "$evaluaciones.2023"] },
              2
          ]},
          4.5
        ]
      }
    },
    // Caso: 3 evaluaciones (2021-2022-2023) con promedio < 4.5
    {
      "evaluaciones.2021": { $exists: true },
      "evaluaciones.2022": { $exists: true },
      "evaluaciones.2023": { $exists: true },
      $expr: {
        $lt: [
          { $divide: [
              { $add: ["$evaluaciones.2021", "$evaluaciones.2022", "$evaluaciones.2023"] },
              3
          ]},
          4.5
        ]
      }
    }
  ]
})
```
</details>

## Ejercicio 07
Filtrar empleados con más de 2 habilidades, una de las cuales sea 'Excel'.

<details>
    <summary>Solución</summary>
```js
db.empleados.find({
    habilidades: "Excel",
    $expr: { $gt: [{ $size: "$habilidades" }, 2] }
})
```
</details>

## Ejercicio 08
Mostrar empleados cuyo nombre y comuna tengan la misma primera letra.

<details>
    <summary>Solución</summary>
```js
db.empleados.find({
    $expr: {
        $eq: [
            { $substr: ["$nombre", 0, 1] },
            { $substr: ["$comuna", 0, 1] }
        ]
    }
})
```
</details>

## Ejercicio 09
Buscar empleados cuyo campo 'direccion' no exista.

<details>
    <summary>Solución</summary>
```js
db.empleados.find({
    direccion: {$exists: false}
})
```
</details>

## Ejercicio 10
Listar empleados que tengan exactamente 3 habilidades.

<details>
    <summary>Solución</summary>
```js
db.empleados.find({
    $expr: {
        $eq: [{$size: "$habilidades"}, 3]
    }
})
```
</details>

## Ejercicio 11
Filtrar empleados con evaluación de 2022 menor a 4.5.

<details>
    <summary>Solución</summary>
```js
db.empleados.find({
    "evaluaciones.2022": {$lt: 4.5}
})
```
</details>

## Ejercicio 12
Mostrar empleados cuyo campo 'evaluaciones' tenga solo 2 años registrados.

<details>
    <summary>Solución</summary>
```js
db.empleados.find({
    $expr: {
         $eq: [{ $size: { $objectToArray: "$evaluaciones" } }, 2] }
})
```
</details>

## Ejercicio 13
Buscar empleados donde la comuna contenga exactamente 6 caracteres.

<details>
    <summary>Solución</summary>
```js
db.empleados.find({
    comuna: /^.{6}$/i
})
```
</details>

## Ejercicio 14
Filtrar empleados donde sueldo dividido por edad sea menor a 50.000 (usar $expr).

<details>
    <summary>Solución</summary>
```js
db.empleados.find({
    $expr: {
        $lt: [
            {$divide: ["$sueldo", "$edad"]},
            50000
        ]
    }
})
```
</details>

## Ejercicio 15
Mostrar empleados donde el largo del nombre sea igual a la suma de habilidades.

<details>
    <summary>Solución</summary>
```js
db.empleados.find({
    $expr: { 
        $eq: [{ $strLenCP: "$nombre" }, { $size: "$habilidades" }] }
})
```
</details>